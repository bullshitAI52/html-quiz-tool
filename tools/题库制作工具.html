<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>题库制作工具</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        /* 原有样式保持不变 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
         
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
         
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
         
        header {
            text-align: center;
            padding: 30px 0;
            margin-bottom: 30px;
        }
         
        h1 {
            font-size: 2.8rem;
            font-weight: 700;
            background: linear-gradient(90deg, #4361ee, #3a0ca3);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
        }
         
        .subtitle {
            color: #6c757d;
            font-size: 1.2rem;
            max-width: 700px;
            margin: 0 auto;
        }
         
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            padding: 30px;
            margin-bottom: 30px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
         
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
        }
         
        .card-title {
            font-size: 1.5rem;
            color: #3a0ca3;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f2f5;
            display: flex;
            align-items: center;
        }
         
        .card-title i {
            margin-right: 10px;
            color: #4361ee;
        }
         
        .form-group {
            margin-bottom: 20px;
        }
         
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
         
        input, textarea, select {
            width: 100%;
            padding: 14px;
            border: 2px solid #e1e5eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
         
        textarea {
            min-height: 120px;
            resize: vertical;
        }
         
        input:focus, textarea:focus, select:focus {
            border-color: #4361ee;
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
        }
         
        .option-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            gap: 10px;
        }
         
        .option-input {
            flex: 1;
        }
         
        .option-actions {
            display: flex;
            gap: 8px;
        }
         
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            gap: 8px;
        }
         
        .btn i {
            font-size: 1.1rem;
        }
         
        .btn-primary {
            background: #4361ee;
            color: white;
        }
         
        .btn-primary:hover {
            background: #3a0ca3;
            transform: translateY(-2px);
        }
         
        .btn-success {
            background: #2a9d8f;
            color: white;
        }
         
        .btn-success:hover {
            background: #21867a;
            transform: translateY(-2px);
        }
         
        .btn-danger {
            background: #e76f51;
            color: white;
        }
         
        .btn-danger:hover {
            background: #d45d3f;
            transform: translateY(-2px);
        }
         
        .btn-outline {
            background: transparent;
            border: 2px solid #4361ee;
            color: #4361ee;
        }
         
        .btn-outline:hover {
            background: #f0f4ff;
        }
         
        .btn-sm {
            padding: 8px 15px;
            font-size: 0.9rem;
        }
         
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
         
        .actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
         
        .question-list {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
         
        .question-list th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            color: #495057;
            font-weight: 600;
            border-bottom: 2px solid #e9ecef;
        }
         
        .question-list td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
        }
         
        .question-list tr:hover td {
            background: #f8f9ff;
        }
         
        .question-text {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
         
        .options-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
         
        .option-tag {
            background: #e7f4ff;
            color: #1a73e8;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }
         
        .option-tag.correct {
            background: #e6f7ee;
            color: #0a9d58;
        }
         
        .list-actions {
            display: flex;
            gap: 10px;
        }
         
        .action-btn {
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: #f8f9fa;
            border: 1px solid #e1e5eb;
            color: #495057;
        }
         
        .action-btn:hover {
            background: #edf2ff;
            color: #4361ee;
            border-color: #d0d9ff;
        }
         
        .preview-card {
            background: #f8f9ff;
            border: 2px dashed #d0d9ff;
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
        }
         
        .preview-title {
            font-size: 1.2rem;
            color: #4361ee;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
         
        .preview-question {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #212529;
        }
         
        .preview-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
         
        .preview-option {
            padding: 15px;
            border: 2px solid #e1e5eb;
            border-radius: 10px;
            background: white;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.2s;
            cursor: default;
        }
         
        .preview-option.correct {
            border-color: #2a9d8f;
            background: #f0faf7;
        }
         
        .option-letter {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #f0f4ff;
            color: #4361ee;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }
         
        .preview-option.correct .option-letter {
            background: #2a9d8f;
            color: white;
        }
         
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
         
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #ced4da;
        }
         
        .counter {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #f0f2f5;
            font-weight: 600;
            color: #495057;
            flex-wrap: wrap;
            gap: 15px;
        }
         
        .counter div {
            background: #f8f9ff;
            padding: 8px 15px;
            border-radius: 8px;
            border: 1px solid #e1e5eb;
        }
         
        .counter span {
            color: #4361ee;
        }
         
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            background: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            transform: translateX(150%);
            transition: transform 0.4s ease;
            z-index: 1000;
        }
         
        .notification.show {
            transform: translateX(0);
        }
         
        .notification.success {
            border-left: 4px solid #2a9d8f;
        }
         
        .notification.error {
            border-left: 4px solid #e76f51;
        }
         
        .notification i {
            font-size: 1.5rem;
        }
         
        .notification.success i {
            color: #2a9d8f;
        }
         
        .notification.error i {
            color: #e76f51;
        }
         
        .notification-content h3 {
            margin-bottom: 5px;
        }
         
        .highlight {
            animation: highlight 1.5s ease;
        }
         
        @keyframes highlight {
            0% { background-color: rgba(67, 97, 238, 0.2); }
            100% { background-color: transparent; }
        }
         
        .question-type {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
         
        .type-option {
            flex: 1;
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            background: #f8f9fa;
            cursor: pointer;
            border: 2px solid #e1e5eb;
            transition: all 0.3s;
        }
         
        .type-option.selected {
            border-color: #4361ee;
            background: #eef2ff;
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.1);
        }
         
        .type-option i {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #4361ee;
        }
         
        .type-option.selected i {
            color: #3a0ca3;
        }
         
        .points-input {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }
         
        .points-input input {
            max-width: 80px;
        }
         
        .points-label {
            font-weight: 600;
        }
         
        .points-hint {
            color: #6c757d;
            font-size: 0.9rem;
        }
         
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
         
        .badge-single {
            background: rgba(67, 97, 238, 0.15);
            color: #4361ee;
        }
         
        .badge-multiple {
            background: rgba(42, 157, 143, 0.15);
            color: #2a9d8f;
        }
         
        .badge-truefalse {
            background: rgba(231, 111, 81, 0.15);
            color: #e76f51;
        }
         
        .badge-fillblank {
            background: rgba(155, 89, 182, 0.15);
            color: #9b59b6;
        }
         
        .badge-essay {
            background: rgba(241, 196, 15, 0.15);
            color: #f39c12;
        }
         
        .badge-points {
            background: rgba(231, 111, 81, 0.15);
            color: #e76f51;
        }
         
        /* 新布局样式 - 优化部分 */
        .import-export-actions {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            margin-top: 20px;
        }
         
        .actions-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            width: 100%;
        }
         
        .action-group {
            display: flex;
            flex: 1;
            min-width: 120px;
            height: 48px;
        }
         
        .filename-group {
            flex: 1;
            min-width: 180px;
            max-width: 300px;
            height: 48px;
        }
         
        .filename-group input {
            padding: 12px 15px;
            height: 100%;
            min-width: 250px;
        }
         
        .encoding-group {
            min-width: 130px;
            max-width: 150px;
            height: 48px;
        }
         
        .encoding-group select {
            padding: 12px 15px;
            padding-right: 35px;
            border-radius: 10px;
            background: #f8f9fa;
            border: 2px solid #4361ee;
            color: #4361ee;
            font-weight: 600;
            cursor: pointer;
            appearance: none;
            position: relative;
            height: 100%;
            width: 100%;
        }
         
        .btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            flex: 1;
        }
         
        .btn-group .btn {
            flex: 1;
            min-width: 120px;
            width: 100%;
            height: 48px;
            padding: 0 15px;
        }
         
        /* 图片相关样式 */
        .image-container {
            margin-top: 10px;
            position: relative;
            display: none;
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e1e5eb;
        }
         
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
            border: 1px solid #e1e5eb;
            overflow: auto;
        }
         
        .image-preview img {
            max-width: 100%;
            max-height: 200px;
            display: block;
        }
         
        .remove-image-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(231, 111, 81, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.8rem;
        }
         
        .add-image-btn {
            margin-top: 8px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: #f0f4ff;
            border: 1px dashed #4361ee;
            border-radius: 8px;
            color: #4361ee;
            cursor: pointer;
            transition: all 0.2s;
        }
         
        .add-image-btn:hover {
            background: #e1e9ff;
        }
         
        .option-image-container {
            margin-top: 8px;
            position: relative;
            display: none;
            background: #f8f9ff;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e1e5eb;
        }
         
        .option-image-preview {
            max-width: 100%;
            max-height: 100px;
            border-radius: 6px;
            margin-top: 8px;
            display: none;
            border: 1px solid #e1e5eb;
            overflow: auto;
        }
         
        .option-image-preview img {
            max-width: 100%;
            max-height: 100px;
            display: block;
        }
         
        .image-input {
            margin-top: 8px;
        }
         
        .image-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #4361ee;
        }
         
        .option-image-label {
            font-size: 0.9rem;
            margin-top: 8px;
        }
         
        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin: 15px 0;
            display: block;
            border: 1px solid #e1e5eb;
        }
         
        .option-preview-image {
            max-width: 100%;
            max-height: 100px;
            border-radius: 6px;
            margin-top: 8px;
        }
         
        .question-text-with-image {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
         
        .option-with-image {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
         
        /* 图片选项样式 */
        .image-option {
            border: 2px solid #e1e5eb;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
         
        .image-option:hover {
            border-color: #4361ee;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
         
        .image-option.selected {
            border-color: #4361ee;
            background-color: #f0f4ff;
        }
         
        .image-option.correct {
            border-color: #2a9d8f;
            background-color: #e6f7ee;
        }
         
        .option-image {
            max-height: 100px;
            max-width: 100%;
            object-fit: contain;
            margin: 0 auto;
            flex-grow: 1;
        }
         
        .option-image-label {
            font-size: 0.9rem;
            margin-top: 5px;
            font-weight: 600;
            color: #4361ee;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
         
        .image-option .option-letter {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 28px;
            height: 28px;
            font-size: 0.9rem;
        }
         
        .image-option-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
         
        .image-option-preview-item {
            border: 2px solid #e1e5eb;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
         
        .image-option-preview-item img {
            max-height: 80px;
            max-width: 100%;
            object-fit: contain;
            margin: 0 auto;
        }
         
        .image-option-preview-label {
            font-size: 0.8rem;
            margin-top: 5px;
            font-weight: 600;
            color: #4361ee;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
         
        .option-type-toggle {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
         
        .option-type-btn {
            flex: 1;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: #f8f9fa;
            border: 2px solid #e1e5eb;
            text-align: center;
            font-size: 0.9rem;
        }
         
        .option-type-btn.selected {
            background: #eef2ff;
            border-color: #4361ee;
            color: #4361ee;
            font-weight: 600;
        }
         
        /* 填空题样式 */
        #blanks-section {
            display: none;
            background: #f8f9ff;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #e1e5eb;
            margin-bottom: 15px;
        }
         
        .blank-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e1e5eb;
        }
         
        .blank-row .blank-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #9b59b6;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }
         
        .blank-input {
            flex: 1;
        }
         
        .blank-points {
            width: 100px;
        }
         
        .scoring-mode {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
         
        .mode-option {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            background: #f8f9fa;
            border: 2px solid #e1e5eb;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
         
        .mode-option.selected {
            background: #f0e6ff;
            border-color: #9b59b6;
            color: #9b59b6;
            font-weight: 600;
        }
         
        .mode-option i {
            margin-right: 5px;
            color: #9b59b6;
        }
         
        .preview-blank {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e1e5eb;
            margin-bottom: 10px;
        }
         
        .preview-blank-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }
         
        .preview-blank-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #9b59b6;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }
         
        .preview-blank-content {
            padding-left: 38px;
        }
         
        .blank-answer {
            background: #f0e6ff;
            padding: 5px 10px;
            border-radius: 4px;
            margin-top: 5px;
            display: inline-block;
        }
         
        /* 填空题增强样式 */
        .question-text-editor {
            position: relative;
        }
         
        .insert-blank-toolbar {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
            display: none; /* 默认隐藏 */
        }
         
        .insert-blank-btn {
            padding: 8px 15px;
            background: #eef2ff;
            border: 1px solid #d0d9ff;
            border-radius: 6px;
            color: #4361ee;
            cursor: pointer;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }
         
        .insert-blank-btn:hover {
            background: #dce5ff;
            transform: translateY(-2px);
        }
         
        .blank-preview {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border: 1px solid #e1e5eb;
        }
         
        .blank-preview-title {
            font-weight: 600;
            color: #4361ee;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
         
        .blank-preview-content {
            line-height: 1.6;
            font-size: 1.1rem;
            padding: 10px;
        }
         
        /* 优化填空项占位符样式 */
        .blank-placeholder {
            display: inline-block;
            position: relative;
            color: #9b59b6;
            font-weight: 600;
            background: rgba(155, 89, 182, 0.08);
            border-bottom: 2px solid #9b59b6;
            padding: 0 8px;
            border-radius: 4px;
            margin: 0 2px;
        }
 
        .blank-answer-reveal {
            display: inline-block;
            position: relative;
            color: #2a9d8f;
            font-weight: 600;
            background: rgba(42, 157, 143, 0.08);
            border-bottom: 2px solid #2a9d8f;
            padding: 0 8px;
            border-radius: 4px;
            margin: 0 2px;
        }
 
        .show-answers-btn {
            margin-top: 15px;
        }
         
        /* 功能说明卡片 */
        .feature-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
         
        .feature-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: transform 0.3s ease;
        }
         
        .feature-card:hover {
            transform: translateY(-5px);
        }
         
        .feature-icon {
            width: 60px;
            height: 60px;
            background: #f0f4ff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            font-size: 1.5rem;
            color: #4361ee;
        }
         
        .feature-title {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #3a0ca3;
        }
         
        /* 拖拽排序样式 */
        .question-list tr.dragging {
            background-color: #f0f7ff;
            opacity: 0.8;
        }
         
        .question-list tr.drag-over {
            border-top: 2px solid #4361ee;
        }
         
        .drag-handle {
            cursor: move;
            padding: 8px;
            color: #6c757d;
            opacity: 0.6;
            transition: all 0.2s;
        }
         
        .drag-handle:hover {
            color: #4361ee;
            opacity: 1;
        }
         
        /* 解答题样式 */
        #essay-section {
            display: none;
            background: #f8f9ff;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #e1e5eb;
            margin-bottom: 15px;
        }
         
        .keyword-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e1e5eb;
        }
         
        .keyword-row .keyword-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #f39c12;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }
         
        .keyword-input {
            flex: 1;
        }
         
        .keyword-points {
            width: 100px;
        }
         
        .preview-keyword {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e1e5eb;
            margin-bottom: 10px;
        }
         
        .preview-keyword-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }
         
        .preview-keyword-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #f39c12;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }
         
        .preview-keyword-content {
            padding-left: 38px;
        }
         
        .keyword-answer {
            background: #fef9e7;
            padding: 5px 10px;
            border-radius: 4px;
            margin-top: 5px;
            display: inline-block;
        }
         
        /* 解答题评分规则 */
        .essay-scoring-mode {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
         
        /* 解答题分数高亮 */
        .essay-points {
            background: rgba(241, 196, 15, 0.2);
            border: 1px solid #f39c12;
        }
         
        /* 响应式设计 */
        @media (max-width: 768px) {
            .actions {
                flex-direction: column;
            }
             
            .btn {
                width: 100%;
            }
             
            .question-list {
                display: block;
                overflow-x: auto;
            }
             
            .preview-options {
                grid-template-columns: 1fr;
            }
             
            .option-row {
                flex-direction: column;
                align-items: flex-start;
            }
             
            .option-actions {
                width: 100%;
                justify-content: space-between;
            }
             
            .import-export-actions {
                flex-direction: column;
            }
             
            .action-group, .filename-group, .encoding-group {
                width: 100%;
                max-width: 100%;
            }
             
            .question-type {
                flex-direction: column;
            }
             
            .truefalse-options {
                flex-direction: column;
            }
             
            .preview-image {
                max-height: 200px;
            }
             
            .image-preview {
                max-height: 150px;
            }
             
            .image-option-preview {
                grid-template-columns: repeat(2, 1fr);
            }
             
            .blank-row, .keyword-row {
                flex-direction: column;
                align-items: stretch;
            }
             
            .blank-points, .keyword-points {
                width: 100%;
            }
             
            .scoring-mode, .essay-scoring-mode {
                flex-direction: column;
            }
             
            .insert-blank-toolbar {
                flex-direction: column;
            }
             
            .insert-blank-btn {
                width: 100%;
                justify-content: center;
            }
             
            /* 移动端按钮优化 */
            .actions-row {
                flex-direction: column;
            }
             
            .action-group {
                min-width: 100%;
                max-width: 100%;
            }
             
            .file-encoding-group {
                flex-direction: column;
                gap: 10px;
            }
             
            .btn-group {
                margin-left: 0;
                width: 100%;
            }
        }
         
        /* 新增布局优化 */
        .file-encoding-group {
            display: flex;
            gap: 15px;
            width: 100%;
        }
         
        /* 导入导出区域优化 */
        .import-export-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            width: 100%;
            margin-bottom: 15px;
        }
         
        .import-section {
            display: flex;
            gap: 15px;
            align-items: center;
        }
         
        .filename-section {
            flex-grow: 1;
            max-width: 350px;
        }
         
        .export-section {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-left: auto;
        }
         
        /* 优化后的操作区域 */
        .import-export-container {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }
         
        .filename-container {
            flex: 1;
            min-width: 200px;
            max-width: 300px;
        }
         
        .encoding-container {
            min-width: 120px;
            max-width: 140px;
        }
         
        .buttons-container {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            flex: 1;
        }
         
        .action-button {
            flex: 1;
            min-width: 150px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 15px;
        }
         
        /* 题目统计卡片 */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
         
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            position: relative;
            border-left: 4px solid #4361ee;
        }
         
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #3a0ca3;
            margin: 10px 0;
        }
         
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
         
        /* 解答题提示 */
        .essay-hint {
            background: #fff8e6;
            border-left: 4px solid #f39c12;
            padding: 10px 15px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
         
        /* 判断题选项样式修复 */
        .truefalse-options {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
         
        .truefalse-option {
            flex: 1;
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            background: #f8f9fa;
            cursor: pointer;
            border: 2px solid #e1e5eb;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
         
        .truefalse-option.selected {
            border-color: #4361ee;
            background: #eef2ff;
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.1);
        }
         
        .truefalse-option:hover {
            border-color: #4361ee;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>题库制作工具</h1>
            <p class="subtitle">支持Excel/CSV导入导出，题目和选项添加图片</p>
        </header>
         
        <div class="card">
            <h2 class="card-title"><i class="fas fa-plus-circle"></i> 添加新题目</h2>
             
            <div class="form-group question-text-editor">
                <label for="question">问题内容 <span style="font-weight:normal;color:#6c757d">(使用 {1}、{2} 等标记填空位置)</span></label>
                <textarea id="question" placeholder="输入问题描述..."></textarea>
                 
                <!-- 插入填空项按钮 -->
                <div class="insert-blank-toolbar" id="insert-blank-toolbar">
                    <div class="insert-blank-btn" id="insert-blank-1">
                        <i class="fas fa-underline"></i> 插入填空项 1
                    </div>
                    <div class="insert-blank-btn" id="insert-blank-2">
                        <i class="fas fa-underline"></i> 插入填空项 2
                    </div>
                    <div class="insert-blank-btn" id="insert-blank-3">
                        <i class="fas fa-underline"></i> 插入填空项 3
                    </div>
                </div>
                 
                <div class="add-image-btn" id="add-question-image-btn">
                    <i class="fas fa-image"></i> 添加题目图片
                </div>
                <div class="image-container" id="question-image-container">
                    <label class="image-label">
                        <i class="fas fa-link"></i> 图片URL:
                    </label>
                    <input type="text" id="question-image-url" class="image-input" placeholder="输入图片URL">
                    <button class="remove-image-btn" id="remove-question-image-btn">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="image-preview" id="question-image-preview"></div>
                </div>
                 
                <!-- 题目预览区域 -->
                <div class="blank-preview">
                    <div class="blank-preview-title">
                        <i class="fas fa-eye"></i> 题目预览
                    </div>
                    <div class="blank-preview-content" id="question-preview"></div>
                </div>
            </div>
             
            <div class="form-group">
                <label>题目类型</label>
                <div class="question-type">
                    <div class="type-option selected" id="single-type">
                        <i class="fas fa-dot-circle"></i>
                        <h3>单选题</h3>
                        <p>只能选择一个正确答案</p>
                    </div>
                    <div class="type-option" id="multiple-type">
                        <i class="fas fa-check-double"></i>
                        <h3>多选题</h3>
                        <p>可选择一个或多个正确答案</p>
                    </div>
                    <div class="type-option" id="truefalse-type">
                        <i class="fas fa-check-circle"></i>
                        <h3>判断题</h3>
                        <p>判断正确或错误</p>
                    </div>
                    <div class="type-option" id="fillblank-type">
                        <i class="fas fa-pen"></i>
                        <h3>填空题</h3>
                        <p>填写正确答案</p>
                    </div>
                    <div class="type-option" id="essay-type">
                        <i class="fas fa-file-alt"></i>
                        <h3>解答题</h3>
                        <p>详细解答问题</p>
                    </div>
                </div>
            </div>
             
            <div class="form-group">
                <label>题目分数</label>
                <div class="points-input">
                    <span class="points-label">分值：</span>
                    <input type="number" id="question-points" min="1" max="10" value="3">
                    <span class="points-hint" id="points-hint">(1-10分)</span>
                </div>
            </div>
             
            <div class="form-group" id="options-section">
                <label>选项设置</label>
                <div id="options-container">
                    <!-- 选项会动态添加到这里 -->
                </div>
                <button id="add-option-btn" class="btn btn-outline" style="margin-top: 10px;">
                    <i class="fas fa-plus"></i> 添加选项
                </button>
            </div>
             
            <div class="form-group" id="truefalse-section" style="display: none;">
                <label>判断题选项</label>
                <div class="truefalse-options">
                    <div class="truefalse-option" id="true-option" data-value="true">
                        <i class="fas fa-check-circle"></i>
                        <span>正确</span>
                    </div>
                    <div class="truefalse-option" id="false-option" data-value="false">
                        <i class="fas fa-times-circle"></i>
                        <span>错误</span>
                    </div>
                </div>
            </div>
             
            <!-- 填空题设置区域 -->
            <div id="blanks-section" style="display: none;">
                <div class="form-group">
                    <label>评分规则</label>
                    <div class="scoring-mode">
                        <div class="mode-option" id="per-blank-mode">
                            <i class="fas fa-check-square"></i> 按空给分
                        </div>
                        <div class="mode-option selected" id="all-or-nothing-mode">
                            <i class="fas fa-ban"></i> 全对给分
                        </div>
                    </div>
                </div>
                 
                <div class="form-group">
                    <label>填空项设置</label>
                    <div id="blanks-container">
                        <!-- 填空项会动态添加到这里 -->
                    </div>
                    <button id="add-blank-btn" class="btn btn-outline" style="margin-top: 10px;">
                        <i class="fas fa-plus"></i> 添加填空项
                    </button>
                </div>
            </div>
             
            <!-- 解答题设置区域 -->
            <div id="essay-section" style="display: none;">
                <div class="essay-hint">
                    <i class="fas fa-info-circle"></i> 解答题可以设置评分关键词（可选），也可以只提供完整答案
                </div>
                 
                <!-- 新增：解答题评分规则 -->
                <div class="form-group">
                    <label>评分规则</label>
                    <div class="essay-scoring-mode">
                        <div class="mode-option selected" id="partial-credit-mode">
                            <i class="fas fa-percentage"></i> 按关键词给分
                        </div>
                        <div class="mode-option" id="all-or-nothing-essay-mode">
                            <i class="fas fa-ban"></i> 全对给分
                        </div>
                    </div>
                </div>
                 
                <div class="form-group">
                    <label for="essay-answer">完整答案 <span style="font-weight:normal;color:#6c757d">(必填)</span></label>
                    <textarea id="essay-answer" placeholder="输入问题的完整答案..."></textarea>
                </div>
                 
                <div class="form-group">
                    <label>评分关键词设置 <span style="font-weight:normal;color:#6c757d">(可选)</span></label>
                    <div id="keywords-container">
                        <!-- 评分关键词会动态添加到这里 -->
                    </div>
                    <button id="add-keyword-btn" class="btn btn-outline" style="margin-top: 10px;">
                        <i class="fas fa-plus"></i> 添加关键词
                    </button>
                </div>
            </div>
             
            <div class="form-group">
                <label for="explanation">答案解析 <span class="hint">(可选)</span></label>
                <textarea id="explanation" placeholder="输入题目解析、解题思路或知识点..."></textarea>
            </div>
             
            <div class="actions">
                <button id="add-question-btn" class="btn btn-primary">
                    <i class="fas fa-save"></i> 保存题目
                </button>
                <button id="preview-btn" class="btn btn-outline">
                    <i class="fas fa-eye"></i> 预览题目
                </button>
                <button id="reset-btn" class="btn btn-outline">
                    <i class="fas fa-redo"></i> 重置表单
                </button>
            </div>
             
            <div id="preview-section" class="preview-card" style="display: none;">
                <div class="preview-title">
                    <i class="fas fa-search"></i> 题目预览
                </div>
                <div id="preview-question-container">
                    <!-- 预览内容会动态生成 -->
                </div>
                <div id="preview-blanks">
                    <!-- 预览内容会动态生成 -->
                </div>
                <div id="preview-keywords">
                    <!-- 预览内容会动态生成 -->
                </div>
                <button id="show-answers-btn" class="btn btn-outline show-answers-btn" style="display: none;">
                    <i class="fas fa-eye"></i> 显示答案
                </button>
                <div id="preview-explanation" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9ff; border-radius: 10px; border-left: 4px solid #4361ee;">
                    <div style="font-weight: 600; color: #4361ee; margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-lightbulb"></i> 答案解析
                    </div>
                    <div id="explanation-content"></div>
                </div>
            </div>
        </div>
         
        <div class="card">
            <h2 class="card-title"><i class="fas fa-list"></i> 题目列表</h2>
             
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-value" id="total-count">0</div>
                    <div class="stat-label">题目总数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-points">0</div>
                    <div class="stat-label">总分数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="image-count">0</div>
                    <div class="stat-label">含图片题目</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="essay-count">0</div>
                    <div class="stat-label">解答题数量</div>
                </div>
            </div>
             
            <div id="questions-table">
                <table class="question-list">
                    <thead>
                        <tr>
                            <th width="5%"></th>
                            <th width="5%">#</th>
                            <th width="20%">问题</th>
                            <th width="20%">选项/关键词</th>
                            <th width="15%">类型</th>
                            <th width="10%">分数</th>
                            <th width="15%">操作</th>
                        </tr>
                    </thead>
                    <tbody id="questions-list">
                        <tr id="empty-row">
                            <td colspan="7" class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <h3>题库为空</h3>
                                <p>请添加题目或导入文件</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
             
            <div class="counter">
                <div>单选题: <span id="single-count">0</span></div>
                <div>多选题: <span id="multiple-count">0</span></div>
                <div>判断题: <span id="truefalse-count">0</span></div>
                <div>填空题: <span id="fillblank-count">0</span></div>
                <div>解答题: <span id="essay-count2">0</span></div>
            </div>
             
            <!-- 优化后的操作按钮区域 -->
            <div class="import-export-actions">
                <div class="import-export-container">
                    <div class="filename-container">
                        <input type="text" id="export-filename" class="filename-input" placeholder="输入文件名" value="我的题库">
                    </div>
                     
                    <div class="encoding-container">
                        <select id="common-encoding">
                            <option value="utf-8">UTF-8</option>
                            <option value="gbk">GBK</option>
                        </select>
                    </div>
                     
                    <div class="buttons-container">
                        <button id="import-btn" class="btn btn-outline action-button">
                            <i class="fas fa-file-import"></i> 导入题库
                        </button>
                        <button id="export-excel-btn" class="btn btn-success action-button" disabled>
                            <i class="fas fa-file-excel"></i> 导出Excel
                        </button>
                        <button id="export-csv-btn" class="btn btn-success action-button" disabled>
                            <i class="fas fa-file-csv"></i> 导出CSV
                        </button>
                        <button id="clear-all-btn" class="btn btn-danger action-button" disabled>
                            <i class="fas fa-trash"></i> 清空题库
                        </button>
                    </div>
                </div>
                <input type="file" id="import-file" accept=".xlsx, .xls, .csv" style="display:none;">
            </div>
             
            <div class="feature-cards">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-file-export"></i>
                    </div>
                    <h3 class="feature-title">多种格式支持</h3>
                    <p>支持Excel和CSV格式导入导出，方便与其他系统集成和交换数据。</p>
                </div>
                 
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-image"></i>
                    </div>
                    <h3 class="feature-title">图片题目支持</h3>
                    <p>题目和选项均可添加图片，特别适合数学、化学等需要公式和图像的科目。</p>
                </div>
                 
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-edit"></i>
                    </div>
                    <h3 class="feature-title">解答题增强</h3>
                    <p>解答题支持完整答案和评分关键词（可选），适用于各种主观题评分场景。</p>
                </div>
            </div>
        </div>
    </div>
     
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <div class="notification-content">
            <h3>操作成功</h3>
            <p id="notification-message">题目已添加到题库</p>
        </div>
    </div>
     
    <script>
        // 全局变量
        let questions = [];
        let optionCounter = 0;
        let blankCounter = 0;
        let keywordCounter = 0;
        let currentType = 'single'; // 默认改为单选题
        let currentPoints = 3;
        let truefalseAnswer = 'true';
        let blankScoringMode = 'allOrNothing';
        let essayScoringMode = 'partialCredit'; // 解答题评分规则（新增）
        let dragSrcEl = null; // 当前拖动的元素
        let dragStartIndex = -1; // 拖动起始索引
         
        // DOM 元素
        const questionInput = document.getElementById('question');
        const essayAnswerInput = document.getElementById('essay-answer');
        const explanationInput = document.getElementById('explanation');
        const pointsInput = document.getElementById('question-points');
        const optionsContainer = document.getElementById('options-container');
        const optionsSection = document.getElementById('options-section');
        const truefalseSection = document.getElementById('truefalse-section');
        const blanksSection = document.getElementById('blanks-section');
        const essaySection = document.getElementById('essay-section');
        const blanksContainer = document.getElementById('blanks-container');
        const keywordsContainer = document.getElementById('keywords-container');
        const addOptionBtn = document.getElementById('add-option-btn');
        const addBlankBtn = document.getElementById('add-blank-btn');
        const addKeywordBtn = document.getElementById('add-keyword-btn');
        const addQuestionBtn = document.getElementById('add-question-btn');
        const previewBtn = document.getElementById('preview-btn');
        const resetBtn = document.getElementById('reset-btn');
        const exportExcelBtn = document.getElementById('export-excel-btn');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const clearAllBtn = document.getElementById('clear-all-btn');
        const importBtn = document.getElementById('import-btn');
        const importFile = document.getElementById('import-file');
        const commonEncoding = document.getElementById('common-encoding');
        const exportFilename = document.getElementById('export-filename');
        const questionsList = document.getElementById('questions-list');
        const emptyRow = document.getElementById('empty-row');
        const previewSection = document.getElementById('preview-section');
        const previewQuestionContainer = document.getElementById('preview-question-container');
        const previewOptions = document.getElementById('preview-options');
        const previewBlanks = document.getElementById('preview-blanks');
        const previewKeywords = document.getElementById('preview-keywords');
        const previewExplanation = document.getElementById('preview-explanation');
        const explanationContent = document.getElementById('explanation-content');
        const notification = document.getElementById('notification');
        const totalCountEl = document.getElementById('total-count');
        const singleCountEl = document.getElementById('single-count');
        const multipleCountEl = document.getElementById('multiple-count');
        const truefalseCountEl = document.getElementById('truefalse-count');
        const fillblankCountEl = document.getElementById('fillblank-count');
        const essayCountEl = document.getElementById('essay-count');
        const essayCountEl2 = document.getElementById('essay-count2');
        const totalPointsEl = document.getElementById('total-points');
        const imageCountEl = document.getElementById('image-count');
        const singleTypeBtn = document.getElementById('single-type');
        const multipleTypeBtn = document.getElementById('multiple-type');
        const truefalseTypeBtn = document.getElementById('truefalse-type');
        const fillblankTypeBtn = document.getElementById('fillblank-type');
        const essayTypeBtn = document.getElementById('essay-type');
        const trueOption = document.getElementById('true-option');
        const falseOption = document.getElementById('false-option');
        const perBlankModeBtn = document.getElementById('per-blank-mode');
        const allOrNothingModeBtn = document.getElementById('all-or-nothing-mode');
        const partialCreditModeBtn = document.getElementById('partial-credit-mode'); // 新增
        const allOrNothingEssayModeBtn = document.getElementById('all-or-nothing-essay-mode'); // 新增
        const questionImageContainer = document.getElementById('question-image-container');
        const questionImageUrl = document.getElementById('question-image-url');
        const questionImagePreview = document.getElementById('question-image-preview');
        const addQuestionImageBtn = document.getElementById('add-question-image-btn');
        const removeQuestionImageBtn = document.getElementById('remove-question-image-btn');
        const questionPreviewEl = document.getElementById('question-preview');
        const showAnswersBtn = document.getElementById('show-answers-btn');
        const insertBlankToolbar = document.getElementById('insert-blank-toolbar');
        const pointsHint = document.getElementById('points-hint');
         
        // 初始化
        function init() {
            // 添加初始选项（单选题需要两个选项）
            addOption();
            addOption();
             
            // 更新预览
            updateQuestionPreview();
             
            // 事件监听
            addOptionBtn.addEventListener('click', addOption);
            addBlankBtn.addEventListener('click', addBlank);
            addKeywordBtn.addEventListener('click', addKeyword);
            addQuestionBtn.addEventListener('click', addQuestion);
            previewBtn.addEventListener('click', togglePreview);
            resetBtn.addEventListener('click', resetForm);
            exportExcelBtn.addEventListener('click', exportExcel);
            exportCsvBtn.addEventListener('click', exportCSV);
            clearAllBtn.addEventListener('click', clearAllQuestions);
            importBtn.addEventListener('click', () => importFile.click());
            importFile.addEventListener('change', handleFileImport);
             
            // 题目类型切换
            singleTypeBtn.addEventListener('click', () => setQuestionType('single'));
            multipleTypeBtn.addEventListener('click', () => setQuestionType('multiple'));
            truefalseTypeBtn.addEventListener('click', () => setQuestionType('truefalse'));
            fillblankTypeBtn.addEventListener('click', () => setQuestionType('fillblank'));
            essayTypeBtn.addEventListener('click', () => setQuestionType('essay'));
             
            // 判断题选项选择
            trueOption.addEventListener('click', () => selectTrueFalseOption('true'));
            falseOption.addEventListener('click', () => selectTrueFalseOption('false'));
             
            // 填空题评分规则选择
            perBlankModeBtn.addEventListener('click', () => setBlankScoringMode('perBlank'));
            allOrNothingModeBtn.addEventListener('click', () => setBlankScoringMode('allOrNothing'));
             
            // 解答题评分规则选择（新增）
            partialCreditModeBtn.addEventListener('click', () => setEssayScoringMode('partialCredit'));
            allOrNothingEssayModeBtn.addEventListener('click', () => setEssayScoringMode('allOrNothing'));
             
            // 分数输入监听
            pointsInput.addEventListener('change', function() {
                let value = parseInt(this.value);
                if (isNaN(value)) value = 1;
                if (value < 1) value = 1;
                 
                // 解答题没有上限，其他题型上限为10分
                if (currentType !== 'essay' && value > 10) {
                    value = 10;
                }
                 
                this.value = value;
                currentPoints = value;
            });
             
            // 题目图片URL输入监听
            questionImageUrl.addEventListener('input', function() {
                const url = this.value.trim();
                if (url) {
                    questionImagePreview.innerHTML = `<img src="${url}" alt="题目图片预览">`;
                    questionImagePreview.style.display = 'block';
                } else {
                    questionImagePreview.style.display = 'none';
                }
            });
             
            // 添加题目图片按钮
            addQuestionImageBtn.addEventListener('click', function() {
                questionImageContainer.style.display = 'block';
                this.style.display = 'none';
            });
             
            // 移除题目图片按钮
            removeQuestionImageBtn.addEventListener('click', function() {
                questionImageContainer.style.display = 'none';
                questionImageUrl.value = '';
                questionImagePreview.style.display = 'none';
                addQuestionImageBtn.style.display = 'inline-flex';
            });
             
            // 题目文本输入监听
            questionInput.addEventListener('input', updateQuestionPreview);
             
            // 插入填空项按钮
            document.querySelectorAll('.insert-blank-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const blankNum = this.id.split('-')[2];
                    insertBlank(blankNum);
                });
            });
             
            // 显示答案按钮
            showAnswersBtn.addEventListener('click', toggleAnswers);
             
            // 初始渲染题目列表
            renderQuestionList();
             
            // 初始化判断题选项
            selectTrueFalseOption(truefalseAnswer);
        }
         
        // 在题目中插入填空项标记
        function insertBlank(blankNum) {
            const textarea = questionInput;
            const startPos = textarea.selectionStart;
            const endPos = textarea.selectionEnd;
            const text = textarea.value;
             
            // 创建填空标记
            const blankMark = `{${blankNum}}`;
             
            // 插入填空标记
            textarea.value = text.substring(0, startPos) + blankMark + text.substring(endPos);
             
            // 设置光标位置
            textarea.selectionStart = startPos + blankMark.length;
            textarea.selectionEnd = startPos + blankMark.length;
             
            // 更新预览
            updateQuestionPreview();
             
            // 聚焦到文本框
            textarea.focus();
        }
         
        // 更新题目预览
        function updateQuestionPreview() {
            const text = questionInput.value;
             
            // 替换填空标记为带序号的占位符（显示为"1、________"）
            const previewText = text.replace(/\{(\d+)\}/g, (match, p1) => {
                return `<span class="blank-placeholder">${p1}、${'________'.repeat(2)}</span>`;
            });
             
            questionPreviewEl.innerHTML = previewText;
        }
         
        // 设置题目类型
        function setQuestionType(type) {
            currentType = type;
             
            // 更新UI
            singleTypeBtn.classList.toggle('selected', type === 'single');
            multipleTypeBtn.classList.toggle('selected', type === 'multiple');
            truefalseTypeBtn.classList.toggle('selected', type === 'truefalse');
            fillblankTypeBtn.classList.toggle('selected', type === 'fillblank');
            essayTypeBtn.classList.toggle('selected', type === 'essay');
             
            // 根据题目类型显示不同的选项区域
            if (type === 'truefalse') {
                optionsSection.style.display = 'none';
                truefalseSection.style.display = 'block';
                blanksSection.style.display = 'none';
                essaySection.style.display = 'none';
                insertBlankToolbar.style.display = 'none';
                 
                // 初始化判断题选项
                selectTrueFalseOption(truefalseAnswer);
            } else if (type === 'fillblank') {
                optionsSection.style.display = 'none';
                truefalseSection.style.display = 'none';
                blanksSection.style.display = 'block';
                essaySection.style.display = 'none';
                insertBlankToolbar.style.display = 'flex';
            } else if (type === 'essay') {
                optionsSection.style.display = 'none';
                truefalseSection.style.display = 'none';
                blanksSection.style.display = 'none';
                essaySection.style.display = 'block';
                insertBlankToolbar.style.display = 'none';
            } else {
                optionsSection.style.display = 'block';
                truefalseSection.style.display = 'none';
                blanksSection.style.display = 'none';
                essaySection.style.display = 'none';
                insertBlankToolbar.style.display = 'none';
            }
             
            // 如果是单选题，确保只有一个正确答案
            if (type === 'single') {
                let foundCorrect = false;
                document.querySelectorAll('.option-row input[type="checkbox"]').forEach(checkbox => {
                    if (foundCorrect) {
                        checkbox.checked = false;
                    } else if (checkbox.checked) {
                        foundCorrect = true;
                    }
                });
            }
             
            // 更新分数输入框限制
            if (type === 'essay') {
                pointsInput.removeAttribute('max');
                pointsHint.textContent = '(1分以上)';
                pointsInput.parentElement.classList.add('essay-points');
            } else {
                pointsInput.setAttribute('max', '10');
                pointsHint.textContent = '(1-10分)';
                pointsInput.parentElement.classList.remove('essay-points');
                 
                // 如果当前分数大于10，修正为10
                if (parseInt(pointsInput.value) > 10) {
                    pointsInput.value = 10;
                    currentPoints = 10;
                }
            }
        }
         
        // 设置填空题评分规则
        function setBlankScoringMode(mode) {
            blankScoringMode = mode;
             
            // 更新UI
            perBlankModeBtn.classList.toggle('selected', mode === 'perBlank');
            allOrNothingModeBtn.classList.toggle('selected', mode === 'allOrNothing');
             
            // 显示/隐藏每个填空项的分值输入框
            document.querySelectorAll('.blank-points').forEach(input => {
                input.style.display = mode === 'perBlank' ? 'block' : 'none';
            });
        }
         
        // 设置解答题评分规则（新增）
        function setEssayScoringMode(mode) {
            essayScoringMode = mode;
             
            // 更新UI
            partialCreditModeBtn.classList.toggle('selected', mode === 'partialCredit');
            allOrNothingEssayModeBtn.classList.toggle('selected', mode === 'allOrNothing');
        }
         
        // 选择判断题答案
        function selectTrueFalseOption(value) {
            truefalseAnswer = value;
             
            // 更新UI
            trueOption.classList.toggle('selected', value === 'true');
            falseOption.classList.toggle('selected', value === 'false');
        }
         
        // 添加新选项
        function addOption() {
            if (optionCounter >= 6) {
                showNotification('最多只能添加6个选项', 'error');
                return;
            }
             
            const optionId = optionCounter;
            const optionRow = document.createElement('div');
            optionRow.className = 'option-row';
            optionRow.innerHTML = `
                <div class="option-input">
                    <input type="text" id="option-${optionId}" placeholder="选项内容（可选）">
                    <div class="add-image-btn add-option-image-btn" data-id="${optionId}">
                        <i class="fas fa-image"></i> 添加选项图片
                    </div>
                    <div class="option-image-container" id="option-image-container-${optionId}" style="display: none;">
                        <label class="option-image-label">
                            <i class="fas fa-link"></i> 选项图片URL:
                        </label>
                        <input type="text" id="option-image-url-${optionId}" class="image-input" placeholder="输入图片URL">
                        <div class="option-image-preview" id="option-image-preview-${optionId}"></div>
                    </div>
                </div>
                <div class="option-actions">
                    <label class="option-checkbox">
                        <input type="checkbox" id="correct-${optionId}"> 正确答案
                    </label>
                    <button class="action-btn delete-option" data-id="${optionId}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
             
            optionsContainer.appendChild(optionRow);
             
            // 添加事件监听
            const deleteBtn = optionRow.querySelector('.delete-option');
            deleteBtn.addEventListener('click', function() {
                if (optionCounter <= 2) {
                    showNotification('至少需要两个选项', 'error');
                    return;
                }
                 
                optionRow.remove();
                optionCounter--;
            });
             
            // 添加选项图片按钮事件
            const addOptionImageBtn = optionRow.querySelector('.add-option-image-btn');
            addOptionImageBtn.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const container = document.getElementById(`option-image-container-${id}`);
                container.style.display = 'block';
                this.style.display = 'none';
            });
             
            // 选项图片URL输入监听
            const optionImageUrl = document.getElementById(`option-image-url-${optionId}`);
            const optionImagePreview = document.getElementById(`option-image-preview-${optionId}`);
             
            optionImageUrl.addEventListener('input', function() {
                const url = this.value.trim();
                if (url) {
                    optionImagePreview.innerHTML = `<img src="${url}" alt="选项图片预览">`;
                    optionImagePreview.style.display = 'block';
                } else {
                    optionImagePreview.style.display = 'none';
                }
            });
             
            optionCounter++;
        }
         
        // 添加新填空项
        function addBlank() {
            if (blankCounter >= 6) {
                showNotification('最多只能添加6个填空项', 'error');
                return;
            }
             
            const blankId = blankCounter;
            const blankRow = document.createElement('div');
            blankRow.className = 'blank-row';
            blankRow.innerHTML = `
                <div class="blank-number">${blankCounter + 1}</div>
                <div class="blank-input">
                    <input type="text" id="blank-${blankId}" placeholder="填空项正确答案">
                </div>
                <input type="number" id="blank-points-${blankId}" class="blank-points" min="1" value="1" ${blankScoringMode === 'allOrNothing' ? 'style="display: none;"' : ''}>
                <button class="action-btn delete-blank" data-id="${blankId}">
                    <i class="fas fa-trash"></i>
                </button>
            `;
             
            blanksContainer.appendChild(blankRow);
             
            // 添加事件监听
            const deleteBtn = blankRow.querySelector('.delete-blank');
            deleteBtn.addEventListener('click', function() {
                if (blankCounter <= 1) {
                    showNotification('至少需要一个填空项', 'error');
                    return;
                }
                 
                blankRow.remove();
                blankCounter--;
                 
                // 更新编号
                document.querySelectorAll('.blank-row').forEach((row, index) => {
                    row.querySelector('.blank-number').textContent = index + 1;
                });
            });
             
            // 分数输入监听 - 移除上限限制
            const pointsInput = document.getElementById(`blank-points-${blankId}`);
            pointsInput.addEventListener('change', function() {
                let value = parseInt(this.value);
                if (isNaN(value)) value = 1;
                if (value < 1) value = 1;
                this.value = value;
            });
             
            blankCounter++;
        }
         
        // 添加评分关键词
        function addKeyword() {
            if (keywordCounter >= 10) {
                showNotification('最多只能添加10个关键词', 'error');
                return;
            }
             
            const keywordId = keywordCounter;
            const keywordRow = document.createElement('div');
            keywordRow.className = 'keyword-row';
            keywordRow.innerHTML = `
                <div class="keyword-number">${keywordCounter + 1}</div>
                <div class="keyword-input">
                    <input type="text" id="keyword-${keywordId}" placeholder="评分关键词">
                </div>
                <input type="number" id="keyword-points-${keywordId}" class="keyword-points" min="1" max="10" value="1">
                <button class="action-btn delete-keyword" data-id="${keywordId}">
                    <i class="fas fa-trash"></i>
                </button>
            `;
             
            keywordsContainer.appendChild(keywordRow);
             
            // 添加事件监听
            const deleteBtn = keywordRow.querySelector('.delete-keyword');
            deleteBtn.addEventListener('click', function() {
                keywordRow.remove();
                keywordCounter--;
                 
                // 更新编号
                document.querySelectorAll('.keyword-row').forEach((row, index) => {
                    row.querySelector('.keyword-number').textContent = index + 1;
                });
            });
             
            // 分数输入监听
            const pointsInput = document.getElementById(`keyword-points-${keywordId}`);
            pointsInput.addEventListener('change', function() {
                let value = parseInt(this.value);
                if (isNaN(value)) value = 1;
                if (value < 1) value = 1;
                if (value > 10) value = 10;
                this.value = value;
            });
             
            keywordCounter++;
        }
         
        // 添加新题目
        function addQuestion() {
            const questionText = questionInput.value.trim();
            const essayAnswer = essayAnswerInput.value.trim();
            const explanation = explanationInput.value.trim();
            const questionImage = questionImageUrl.value.trim();
             
            // 验证问题
            if (!questionText) {
                showNotification('请输入问题内容', 'error');
                return;
            }
             
            // 收集选项
            const options = [];
            let correctAnswers = [];
            let hasOptions = false;
            let blanks = [];
            let keywords = [];
             
            if (currentType === 'truefalse') {
                // 判断题特殊处理
                options.push({
                    text: '正确',
                });
                options.push({
                    text: '错误',
                });
                correctAnswers = [truefalseAnswer === 'true' ? 'A' : 'B'];
            } else if (currentType === 'fillblank') {
                // 填空题处理
                document.querySelectorAll('.blank-row').forEach((row, index) => {
                    const blankInput = row.querySelector('input[type="text"]');
                    const blankValue = blankInput ? blankInput.value.trim() : '';
                    const pointsInput = row.querySelector('input[type="number"]');
                    const points = pointsInput ? parseInt(pointsInput.value) : 0;
                     
                    if (blankValue) {
                        hasOptions = true;
                        blanks.push({
                            answer: blankValue,
                            points: points
                        });
                    }
                });
                 
                if (blanks.length === 0) {
                    showNotification('请至少输入一个填空项', 'error');
                    return;
                }
            } else if (currentType === 'essay') {
                // 解答题处理
                document.querySelectorAll('.keyword-row').forEach((row, index) => {
                    const keywordInput = row.querySelector('input[type="text"]');
                    const keywordValue = keywordInput ? keywordInput.value.trim() : '';
                    const pointsInput = row.querySelector('input[type="number"]');
                    const points = pointsInput ? parseInt(pointsInput.value) : 0;
                     
                    if (keywordValue) {
                        hasOptions = true;
                        keywords.push({
                            keyword: keywordValue,
                            points: points
                        });
                    }
                });
                 
                // 解答题完整答案是必填项
                if (!essayAnswer) {
                    showNotification('请输入完整答案', 'error');
                    return;
                }
            } else {
                // 遍历所有选项行
                document.querySelectorAll('.option-row').forEach((row, index) => {
                    const optionInput = row.querySelector('input[type="text"]');
                    const optionValue = optionInput ? optionInput.value.trim() : '';
                    const correctCheckbox = row.querySelector('input[type="checkbox"]');
                    const optionImageUrl = row.querySelector('.option-image-container input[type="text"]');
                    const optionImage = optionImageUrl ? optionImageUrl.value.trim() : '';
                     
                    if (optionValue || optionImage) {
                        hasOptions = true;
                        options.push({
                            text: optionValue,
                            image: optionImage
                        });
                         
                        if (correctCheckbox && correctCheckbox.checked) {
                            // 正确答案使用字母表示 (A, B, C...)
                            correctAnswers.push(String.fromCharCode(65 + index));
                        }
                    }
                });
                 
                if (!hasOptions) {
                    showNotification('请至少输入一个选项或添加选项图片', 'error');
                    return;
                }
                 
                if (correctAnswers.length === 0) {
                    showNotification('请至少选择一个正确答案', 'error');
                    return;
                }
                 
                // 如果是单选题，但选择了多个答案
                if (currentType === 'single' && correctAnswers.length > 1) {
                    showNotification('单选题只能选择一个正确答案', 'error');
                    return;
                }
            }
             
            // 创建题目对象
            const question = {
                id: Date.now(), // 唯一ID
                text: questionText,
                image: questionImage,
                explanation: explanation,
                type: currentType,
                points: currentPoints,
                options: options,
                correct: correctAnswers,
                blanks: blanks,
                essayAnswer: essayAnswer,
                keywords: keywords,
                blankScoringMode: blankScoringMode,
                essayScoringMode: essayScoringMode // 新增解答题评分规则
            };
             
            // 添加到题库
            questions.push(question);
             
            // 更新UI
            renderQuestionList();
            resetForm();
            showNotification('题目已添加到题库');
             
            // 启用按钮
            exportExcelBtn.disabled = false;
            exportCsvBtn.disabled = false;
            clearAllBtn.disabled = false;
        }
         
        // 渲染题目列表
        function renderQuestionList() {
            // 隐藏空状态
            if (emptyRow) emptyRow.style.display = questions.length ? 'none' : '';
             
            // 清空列表
            questionsList.innerHTML = '';
             
            if (questions.length === 0) {
                questionsList.appendChild(emptyRow);
                emptyRow.style.display = '';
                return;
            }
             
            // 添加题目
            let singleCount = 0;
            let multipleCount = 0;
            let truefalseCount = 0;
            let fillblankCount = 0;
            let essayCount = 0;
            let imageCount = 0;
            let totalPoints = 0;
             
            questions.forEach((q, index) => {
                // 统计题目类型
                if (q.type === 'single') singleCount++;
                else if (q.type === 'multiple') multipleCount++;
                else if (q.type === 'truefalse') truefalseCount++;
                else if (q.type === 'fillblank') fillblankCount++;
                else if (q.type === 'essay') essayCount++;
                 
                // 统计题目图片
                if (q.image) imageCount++;
                 
                // 统计总分
                totalPoints += q.points;
                 
                const row = document.createElement('tr');
                row.setAttribute('data-id', q.id);
                row.setAttribute('data-index', index);
                row.draggable = true; // 启用拖拽
                 
                if (index === questions.length - 1) {
                    row.classList.add('highlight');
                }
                 
                // 生成选项预览
                let optionsHtml = '';
                 
                if (q.type === 'fillblank') {
                    // 填空题预览
                    optionsHtml = `<div class="options-preview">`;
                    q.blanks.forEach((blank, idx) => {
                        optionsHtml += `
                            <div class="option-tag">
                                ${idx+1}. ${blank.answer}
                            </div>
                        `;
                    });
                    optionsHtml += `</div>`;
                } else if (q.type === 'truefalse') {
                    // 判断题特殊显示
                    q.options.forEach((opt, optIndex) => {
                        const isCorrect = q.correct.includes(String.fromCharCode(65 + optIndex));
                        optionsHtml += `
                            <div class="option-tag ${isCorrect ? 'correct' : ''}">
                                ${opt.text} ${isCorrect ? '<i class="fas fa-check"></i>' : ''}
                            </div>
                        `;
                    });
                } else if (q.type === 'essay') {
                    // 解答题关键词预览
                    if (q.keywords && q.keywords.length > 0) {
                        optionsHtml = `<div class="options-preview">`;
                        q.keywords.forEach((kw, idx) => {
                            optionsHtml += `
                                <div class="option-tag">
                                    ${kw.keyword} (${kw.points}分)
                                </div>
                            `;
                        });
                        optionsHtml += `</div>`;
                    } else {
                        optionsHtml = `<div class="option-tag">无关键词</div>`;
                    }
                } else {
                    // 选择题预览
                    q.options.forEach((opt, optIndex) => {
                        const isCorrect = q.correct.includes(String.fromCharCode(65 + optIndex));
                         
                        let optionContent = `
                            <div class="option-tag ${isCorrect ? 'correct' : ''}">
                        `;
                         
                        if (opt.image) {
                            optionContent += `
                                <div class="image-option-preview-item">
                                    <img src="${opt.image}" alt="选项图片">
                                    <div class="image-option-preview-label">${opt.text || '图片选项'}</div>
                                </div>
                            `;
                        } else {
                            optionContent += `
                                ${String.fromCharCode(65 + optIndex)}: ${opt.text || ''}
                                ${isCorrect ? '<i class="fas fa-check"></i>' : ''}
                            `;
                        }
                         
                        optionContent += `</div>`;
                        optionsHtml += optionContent;
                    });
                }
                 
                // 题目类型显示
                let typeBadge = '';
                if (q.type === 'single') {
                    typeBadge = '<span class="badge badge-single">单选题</span>';
                } else if (q.type === 'multiple') {
                    typeBadge = '<span class="badge badge-multiple">多选题</span>';
                } else if (q.type === 'truefalse') {
                    typeBadge = '<span class="badge badge-truefalse">判断题</span>';
                } else if (q.type === 'fillblank') {
                    typeBadge = '<span class="badge badge-fillblank">填空题</span>';
                } else if (q.type === 'essay') {
                    typeBadge = '<span class="badge badge-essay">解答题</span>';
                }
                 
                // 问题内容显示（含图片）
                let questionContent = '';
                if (q.type === 'fillblank') {
                    // 对于填空题，替换填空标记为占位符（显示为"1、________"）
                    const previewText = q.text.replace(/\{(\d+)\}/g, (match, p1) => {
                        return `<span class="blank-placeholder">${p1}、${'________'.repeat(2)}</span>`;
                    });
                    questionContent = `<div>${previewText}</div>`;
                } else {
                    questionContent = `<div class="question-text">${q.text}</div>`;
                }
                 
                if (q.image) {
                    questionContent = `
                        <div class="question-text-with-image">
                            ${questionContent}
                            <img src="${q.image}" alt="题目图片" style="max-width: 100px; max-height: 60px;">
                        </div>
                    `;
                }
                 
                row.innerHTML = `
                    <td class="drag-handle" title="拖动排序"><i class="fas fa-grip-vertical"></i></td>
                    <td>${index + 1}</td>
                    <td class="question-text">${questionContent}</td>
                    <td>
                        ${optionsHtml}
                    </td>
                    <td>
                        ${typeBadge}
                    </td>
                    <td>
                        <span class="badge badge-points ${q.type === 'essay' ? 'essay-points' : ''}">${q.points}分</span>
                    </td>
                    <td>
                        <div class="list-actions">
                            <button class="action-btn edit-btn" data-id="${q.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete-btn" data-id="${q.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                 
                questionsList.appendChild(row);
            });
             
            // 添加事件监听
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    editQuestion(id);
                });
            });
             
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    deleteQuestion(id);
                });
            });
             
            // 添加拖拽事件监听
            setupDragAndDrop();
             
            // 更新计数
            totalCountEl.textContent = questions.length;
            singleCountEl.textContent = singleCount;
            multipleCountEl.textContent = multipleCount;
            truefalseCountEl.textContent = truefalseCount;
            fillblankCountEl.textContent = fillblankCount;
            essayCountEl.textContent = essayCount;
            essayCountEl2.textContent = essayCount;
            totalPointsEl.textContent = totalPoints;
            imageCountEl.textContent = imageCount;
        }
         
        // 设置拖拽排序功能
        function setupDragAndDrop() {
            const rows = document.querySelectorAll('#questions-list tr:not(.empty-state)');
             
            rows.forEach(row => {
                row.addEventListener('dragstart', handleDragStart);
                row.addEventListener('dragover', handleDragOver);
                row.addEventListener('dragenter', handleDragEnter);
                row.addEventListener('dragleave', handleDragLeave);
                row.addEventListener('drop', handleDrop);
                row.addEventListener('dragend', handleDragEnd);
            });
        }
         
        // 拖拽开始
        function handleDragStart(e) {
            dragSrcEl = this;
            dragStartIndex = parseInt(this.getAttribute('data-index'));
            this.classList.add('dragging');
             
            // 设置拖拽效果
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML);
        }
         
        // 拖拽经过
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault(); // 允许放置
            }
             
            e.dataTransfer.dropEffect = 'move';
            return false;
        }
         
        // 拖拽进入
        function handleDragEnter(e) {
            this.classList.add('drag-over');
        }
         
        // 拖拽离开
        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }
         
        // 放置
        function handleDrop(e) {
            e.stopPropagation(); // 阻止冒泡
            e.preventDefault();
             
            if (dragSrcEl !== this) {
                const dragEndIndex = parseInt(this.getAttribute('data-index'));
                 
                // 交换数组中的元素
                [questions[dragStartIndex], questions[dragEndIndex]] = 
                [questions[dragEndIndex], questions[dragStartIndex]];
                 
                // 重新渲染题目列表
                renderQuestionList();
            }
             
            return false;
        }
         
        // 拖拽结束
        function handleDragEnd(e) {
            // 移除所有行的拖拽样式
            document.querySelectorAll('#questions-list tr').forEach(row => {
                row.classList.remove('dragging');
                row.classList.remove('drag-over');
            });
        }
         
        // 编辑题目
        function editQuestion(id) {
            const question = questions.find(q => q.id == id);
            if (!question) return;
             
            // 填充表单
            questionInput.value = question.text;
            essayAnswerInput.value = question.essayAnswer || '';
            explanationInput.value = question.explanation || '';
            pointsInput.value = question.points;
            currentPoints = question.points;
             
            // 设置题目图片
            if (question.image) {
                questionImageUrl.value = question.image;
                questionImagePreview.innerHTML = `<img src="${question.image}" alt="题目图片预览">`;
                questionImagePreview.style.display = 'block';
                questionImageContainer.style.display = 'block';
                addQuestionImageBtn.style.display = 'none';
            }
             
            // 设置题目类型
            setQuestionType(question.type);
             
            // 更新预览
            updateQuestionPreview();
             
            // 判断题特殊处理
            if (question.type === 'truefalse') {
                // 设置判断题答案
                const answer = question.correct[0];
                truefalseAnswer = answer === 'A' ? 'true' : 'false';
                selectTrueFalseOption(truefalseAnswer);
            } else if (question.type === 'fillblank') {
                // 设置填空题
                setBlankScoringMode(question.blankScoringMode || 'allOrNothing');
                 
                // 清空填空项
                blanksContainer.innerHTML = '';
                blankCounter = 0;
                 
                // 添加填空项
                question.blanks.forEach(blank => {
                    addBlank();
                     
                    const blankInput = document.getElementById(`blank-${blankCounter - 1}`);
                    const pointsInput = document.getElementById(`blank-points-${blankCounter - 1}`);
                     
                    if (blankInput) {
                        blankInput.value = blank.answer || '';
                         
                        if (pointsInput) {
                            pointsInput.value = blank.points || 1;
                        }
                    }
                });
            } else if (question.type === 'essay') {
                // 设置解答题
                setEssayScoringMode(question.essayScoringMode || 'partialCredit');
                 
                // 清空关键词
                keywordsContainer.innerHTML = '';
                keywordCounter = 0;
                 
                // 添加关键词
                question.keywords.forEach(kw => {
                    addKeyword();
                     
                    const keywordInput = document.getElementById(`keyword-${keywordCounter - 1}`);
                    const pointsInput = document.getElementById(`keyword-points-${keywordCounter - 1}`);
                     
                    if (keywordInput) {
                        keywordInput.value = kw.keyword || '';
                         
                        if (pointsInput) {
                            pointsInput.value = kw.points || 1;
                        }
                    }
                });
            } else {
                // 清空选项
                optionsContainer.innerHTML = '';
                optionCounter = 0;
                 
                // 添加选项
                question.options.forEach((opt, index) => {
                    addOption();
                     
                    const optionInput = document.getElementById(`option-${optionCounter - 1}`);
                    const correctCheckbox = document.getElementById(`correct-${optionCounter - 1}`);
                    const optionImageInput = document.getElementById(`option-image-url-${optionCounter - 1}`);
                    const optionImagePreview = document.getElementById(`option-image-preview-${optionCounter - 1}`);
                     
                    if (optionInput) {
                        optionInput.value = opt.text || '';
                         
                        // 设置选项图片
                        if (opt.image) {
                            optionImageInput.value = opt.image;
                            optionImagePreview.innerHTML = `<img src="${opt.image}" alt="选项图片预览">`;
                            optionImagePreview.style.display = 'block';
                            document.getElementById(`option-image-container-${optionCounter - 1}`).style.display = 'block';
                            document.querySelector(`[data-id="${optionCounter - 1}"].add-option-image-btn`).style.display = 'none';
                        }
                         
                        // 设置正确答案
                        const isCorrect = question.correct.includes(String.fromCharCode(65 + index));
                        if (correctCheckbox) {
                            correctCheckbox.checked = isCorrect;
                        }
                    }
                });
            }
             
            // 删除原始题目
            deleteQuestion(id);
             
            // 滚动到顶部
            window.scrollTo(0, 0);
        }
         
        // 删除题目
        function deleteQuestion(id) {
            questions = questions.filter(q => q.id != id);
            renderQuestionList();
             
            if (questions.length === 0) {
                if (emptyRow) emptyRow.style.display = '';
                exportExcelBtn.disabled = true;
                exportCsvBtn.disabled = true;
                clearAllBtn.disabled = true;
            }
        }
         
        // 重置表单
        function resetForm() {
            questionInput.value = '';
            essayAnswerInput.value = '';
            explanationInput.value = '';
            optionsContainer.innerHTML = '';
            blanksContainer.innerHTML = '';
            keywordsContainer.innerHTML = '';
            optionCounter = 0;
            blankCounter = 0;
            keywordCounter = 0;
            previewSection.style.display = 'none';
            currentPoints = 1;
            pointsInput.value = 1;
            setQuestionType('single');
            truefalseAnswer = 'true';
            selectTrueFalseOption('true');
            setBlankScoringMode('allOrNothing');
            setEssayScoringMode('partialCredit'); // 重置为按关键词给分
             
            // 重置题目图片
            questionImageUrl.value = '';
            questionImagePreview.style.display = 'none';
            questionImageContainer.style.display = 'none';
            addQuestionImageBtn.style.display = 'inline-flex';
             
            // 更新预览
            updateQuestionPreview();
             
            // 重新添加两个选项（单选题）
            addOption();
            addOption();
        }
         
        // 切换预览
        function togglePreview() {
            const questionText = questionInput.value.trim();
            const essayAnswer = essayAnswerInput.value.trim();
            const explanation = explanationInput.value.trim();
            const questionImage = questionImageUrl.value.trim();
             
            if (!questionText) {
                showNotification('请输入问题内容', 'error');
                return;
            }
             
            // 收集选项
            const options = [];
            let correctAnswers = [];
            let blanks = [];
            let keywords = [];
             
            if (currentType === 'truefalse') {
                // 判断题特殊处理
                options.push({
                    text: '正确',
                });
                options.push({
                    text: '错误',
                });
                correctAnswers = [truefalseAnswer === 'true' ? 'A' : 'B'];
            } else if (currentType === 'fillblank') {
                // 填空题处理
                document.querySelectorAll('.blank-row').forEach((row, index) => {
                    const blankInput = row.querySelector('input[type="text"]');
                    const blankValue = blankInput ? blankInput.value.trim() : '';
                    const pointsInput = row.querySelector('input[type="number"]');
                    const points = pointsInput ? parseInt(pointsInput.value) : 0;
                     
                    if (blankValue) {
                        blanks.push({
                            answer: blankValue,
                            points: points,
                            index: index + 1
                        });
                    }
                });
                 
                if (blanks.length === 0) {
                    showNotification('请至少输入一个填空项', 'error');
                    return;
                }
            } else if (currentType === 'essay') {
                // 解答题处理
                document.querySelectorAll('.keyword-row').forEach((row, index) => {
                    const keywordInput = row.querySelector('input[type="text"]');
                    const keywordValue = keywordInput ? keywordInput.value.trim() : '';
                    const pointsInput = row.querySelector('input[type="number"]');
                    const points = pointsInput ? parseInt(pointsInput.value) : 0;
                     
                    if (keywordValue) {
                        keywords.push({
                            keyword: keywordValue,
                            points: points,
                            index: index + 1
                        });
                    }
                });
                 
                if (!essayAnswer) {
                    showNotification('请输入完整答案', 'error');
                    return;
                }
            } else {
                let hasOptions = false;
                 
                // 遍历所有选项行
                document.querySelectorAll('.option-row').forEach((row, index) => {
                    const optionInput = row.querySelector('input[type="text"]');
                    const optionValue = optionInput ? optionInput.value.trim() : '';
                    const correctCheckbox = row.querySelector('input[type="checkbox"]');
                    const optionImageUrl = row.querySelector('.option-image-container input[type="text"]');
                    const optionImage = optionImageUrl ? optionImageUrl.value.trim() : '';
                     
                    if (optionValue || optionImage) {
                        hasOptions = true;
                        options.push({
                            text: optionValue,
                            image: optionImage
                        });
                         
                        if (correctCheckbox && correctCheckbox.checked) {
                            correctAnswers.push(index);
                        }
                    }
                });
                 
                if (!hasOptions) {
                    showNotification('请至少输入一个选项或添加选项图片', 'error');
                    return;
                }
                 
                if (correctAnswers.length === 0) {
                    showNotification('请至少选择一个正确答案', 'error');
                    return;
                }
                 
                // 如果是单选题，但选择了多个答案
                if (currentType === 'single' && correctAnswers.length > 1) {
                    showNotification('单选题只能选择一个正确答案', 'error');
                    return;
                }
            }
             
            // 更新预览
            previewQuestionContainer.innerHTML = '';
            previewBlanks.innerHTML = '';
            previewKeywords.innerHTML = '';
            previewExplanation.style.display = 'none';
            showAnswersBtn.style.display = 'none';
             
            // 预览题目类型和分数
            const typeInfo = document.createElement('div');
            typeInfo.style.marginBottom = '15px';
            typeInfo.style.display = 'flex';
            typeInfo.style.gap = '15px';
             
            let typeBadge = '';
            if (currentType === 'single') {
                typeBadge = '<span class="badge badge-single">单选题</span>';
            } else if (currentType === 'multiple') {
                typeBadge = '<span class="badge badge-multiple">多选题</span>';
            } else if (currentType === 'truefalse') {
                typeBadge = '<span class="badge badge-truefalse">判断题</span>';
            } else if (currentType === 'fillblank') {
                typeBadge = '<span class="badge badge-fillblank">填空题</span>';
            } else if (currentType === 'essay') {
                typeBadge = '<span class="badge badge-essay">解答题</span>';
            }
             
            let scoringInfo = '';
            if (currentType === 'fillblank') {
                scoringInfo = blankScoringMode === 'perBlank' 
                    ? '<span class="badge" style="background: rgba(46, 204, 113, 0.15); color: #2ecc71;">按空给分</span>' 
                    : '<span class="badge" style="background: rgba(231, 76, 60, 0.15); color: #e74c3c;">全对给分</span>';
            } else if (currentType === 'essay') {
                scoringInfo = essayScoringMode === 'partialCredit' 
                    ? '<span class="badge" style="background: rgba(46, 204, 113, 0.15); color: #2ecc71;">按关键词给分</span>' 
                    : '<span class="badge" style="background: rgba(231, 76, 60, 0.15); color: #e74c3c;">全对给分</span>';
            }
             
            typeInfo.innerHTML = `
                ${typeBadge}
                ${scoringInfo}
                <span class="badge badge-points ${currentType === 'essay' ? 'essay-points' : ''}">${currentPoints}分</span>
            `;
             
            // 预览问题
            const questionPreview = document.createElement('div');
            questionPreview.className = 'preview-question';
             
            if (currentType === 'fillblank') {
                // 对于填空题，替换填空标记为占位符（显示为"1、________"）
                const previewText = questionText.replace(/\{(\d+)\}/g, (match, p1) => {
                    return `<span class="blank-placeholder">${p1}、${'________'.repeat(2)}</span>`;
                });
                questionPreview.innerHTML = previewText;
            } else {
                questionPreview.textContent = questionText;
            }
             
            previewQuestionContainer.appendChild(typeInfo);
            previewQuestionContainer.appendChild(questionPreview);
             
            // 预览题目图片
            if (questionImage) {
                const imagePreview = document.createElement('img');
                imagePreview.src = questionImage;
                imagePreview.alt = '题目图片预览';
                imagePreview.className = 'preview-image';
                previewQuestionContainer.appendChild(imagePreview);
            }
             
            // 预览选项
            if (currentType === 'fillblank') {
                previewBlanks.style.display = 'block';
                showAnswersBtn.style.display = 'block';
                showAnswersBtn.innerHTML = '<i class="fas fa-eye"></i> 显示答案';
                 
                blanks.forEach((blank, index) => {
                    const blankEl = document.createElement('div');
                    blankEl.className = 'preview-blank';
                    blankEl.innerHTML = `
                        <div class="preview-blank-header">
                            <div class="preview-blank-number">${index + 1}</div>
                            <div>填空项 ${index + 1}</div>
                        </div>
                        <div class="preview-blank-content">
                            <div>正确答案: <span class="blank-answer">${blank.answer}</span></div>
                            ${blankScoringMode === 'perBlank' ? `<div>分值: ${blank.points}分</div>` : ''}
                        </div>
                    `;
                    previewBlanks.appendChild(blankEl);
                });
            } else if (currentType === 'essay') {
                // 解答题预览
                previewKeywords.style.display = 'block';
                 
                // 预览完整答案
                const answerPreview = document.createElement('div');
                answerPreview.className = 'preview-card';
                answerPreview.innerHTML = `
                    <div class="preview-title">
                        <i class="fas fa-file-alt"></i> 完整答案
                    </div>
                    <div style="margin-top: 15px; padding: 15px; background: #fffaf0; border-radius: 8px; border: 1px solid #ffeeba;">
                        ${essayAnswer.replace(/\n/g, '<br>')}
                    </div>
                `;
                previewQuestionContainer.appendChild(answerPreview);
                 
                // 预览评分关键词
                if (keywords.length > 0) {
                    const keywordsPreview = document.createElement('div');
                    keywordsPreview.className = 'preview-card';
                    keywordsPreview.innerHTML = `
                        <div class="preview-title">
                            <i class="fas fa-key"></i> 评分关键词
                        </div>
                        <div id="keywords-preview-list" style="margin-top: 15px;"></div>
                    `;
                    previewQuestionContainer.appendChild(keywordsPreview);
                     
                    const keywordsList = keywordsPreview.querySelector('#keywords-preview-list');
                     
                    keywords.forEach((kw, index) => {
                        const keywordEl = document.createElement('div');
                        keywordEl.className = 'preview-keyword';
                        keywordEl.innerHTML = `
                            <div class="preview-keyword-header">
                                <div class="preview-keyword-number">${index + 1}</div>
                                <div>关键词 ${index + 1}</div>
                            </div>
                            <div class="preview-keyword-content">
                                <div>关键词: <span class="keyword-answer">${kw.keyword}</span></div>
                                <div>分值: ${kw.points}分</div>
                            </div>
                        `;
                        keywordsList.appendChild(keywordEl);
                    });
                }
            } else {
                previewBlanks.style.display = 'none';
                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'preview-options';
                previewQuestionContainer.appendChild(optionsContainer);
                 
                options.forEach((opt, index) => {
                    const isCorrect = correctAnswers.includes(index);
                     
                    if (currentType === 'truefalse') {
                        // 判断题特殊显示
                        const optionEl = document.createElement('div');
                        optionEl.className = `preview-option ${isCorrect ? 'correct' : ''}`;
                        optionEl.innerHTML = `
                            <div class="option-letter">${index === 0 ? '√' : '×'}</div>
                            <div>${opt.text}</div>
                        `;
                        optionsContainer.appendChild(optionEl);
                    } else {
                        // 图片选项显示
                        const optionEl = document.createElement('div');
                        optionEl.className = `image-option ${isCorrect ? 'correct' : ''}`;
                         
                        let content = `
                            <div class="option-letter">${String.fromCharCode(65 + index)}</div>
                        `;
                         
                        if (opt.image) {
                            content += `
                                <img src="${opt.image}" alt="选项图片" class="option-image">
                            `;
                        }
                         
                        if (opt.text) {
                            content += `
                                <div class="option-image-label">${opt.text}</div>
                            `;
                        }
                         
                        optionEl.innerHTML = content;
                        optionsContainer.appendChild(optionEl);
                    }
                });
            }
             
            // 预览答案解析
            if (explanation) {
                explanationContent.textContent = explanation;
                previewExplanation.style.display = 'block';
            }
             
            previewSection.style.display = 'block';
        }
         
        // 切换答案显示
        function toggleAnswers() {
            const questionText = questionInput.value.trim();
            const blanks = [];
             
            // 收集填空项
            document.querySelectorAll('.blank-row').forEach((row, index) => {
                const blankInput = row.querySelector('input[type="text"]');
                const blankValue = blankInput ? blankInput.value.trim() : '';
                 
                if (blankValue) {
                    blanks.push({
                        answer: blankValue,
                        index: index + 1
                    });
                }
            });
             
            const questionPreview = previewQuestionContainer.querySelector('.preview-question');
             
            if (showAnswersBtn.textContent.includes('显示')) {
                // 显示答案
                const previewText = questionText.replace(/\{(\d+)\}/g, (match, p1) => {
                    const index = parseInt(p1);
                    const blank = blanks.find(b => b.index === index);
                    if (blank) {
                        return `<span class="blank-answer-reveal">${blank.answer}</span>`;
                    }
                    return match;
                });
                questionPreview.innerHTML = previewText;
                showAnswersBtn.innerHTML = '<i class="fas fa-eye-slash"></i> 隐藏答案';
            } else {
                // 隐藏答案
                const previewText = questionText.replace(/\{(\d+)\}/g, (match, p1) => {
                    return `<span class="blank-placeholder">${p1}、${'________'.repeat(2)}</span>`;
                });
                questionPreview.innerHTML = previewText;
                showAnswersBtn.innerHTML = '<i class="fas fa-eye"></i> 显示答案';
            }
        }
         
        // 清空所有题目
        function clearAllQuestions() {
            if (!confirm('确定要清空所有题目吗？此操作不可恢复。')) return;
             
            questions = [];
            renderQuestionList();
            if (emptyRow) emptyRow.style.display = '';
            exportExcelBtn.disabled = true;
            exportCsvBtn.disabled = true;
            clearAllBtn.disabled = true;
            showNotification('已清空题库');
        }
         
        // 导出Excel
        function exportExcel() {
            if (questions.length === 0) {
                showNotification('题库为空，无法导出', 'error');
                return;
            }
             
            // 创建工作簿
            const wb = XLSX.utils.book_new();
            wb.SheetNames.push("题库");
             
            // 准备数据
            const data = [
                // 标题行
                ["问题", "问题图片", "选项A", "选项A图片", "选项B", "选项B图片", "选项C", "选项C图片", "选项D", "选项D图片", "选项E", "选项E图片", "选项F", "选项F图片", "答案", "题目类型", "题目分数", "答案解析", "填空项1", "填空项1分值", "填空项2", "填空项2分值", "填空项3", "填空项3分值", "填空项4", "填空项4分值", "填空项5", "填空项5分值", "填空项6", "填空项6分值", "完整答案", "关键词1", "关键词1分值", "关键词2", "关键词2分值", "关键词3", "关键词3分值", "关键词4", "关键词4分值", "关键词5", "关键词5分值", "评分规则"]
            ];
             
            questions.forEach(q => {
                // 添加问题
                const row = [q.text || "", q.image || ""];
                 
                // 添加选项（最多6个）
                for (let i = 0; i < 6; i++) {
                    if (i < q.options.length) {
                        // 选项文本
                        const text = q.options[i].text || "";
                        row.push(text);
                         
                        // 选项图片
                        const image = q.options[i].image || "";
                        row.push(image);
                    } else {
                        // 空选项（文本和图片）
                        row.push("");
                        row.push("");
                    }
                }
                 
                // 添加答案
                row.push(q.correct.join(''));
                 
                // 添加题目类型
                row.push(q.type);
                 
                // 添加题目分数
                row.push(q.points);
                 
                // 添加答案解析
                row.push(q.explanation || "");
                 
                // 添加填空项（最多6个）
                for (let i = 0; i < 6; i++) {
                    if (i < (q.blanks ? q.blanks.length : 0)) {
                        // 填空项答案
                        const answer = q.blanks[i].answer || "";
                        row.push(answer);
                         
                        // 填空项分值
                        const points = q.blanks[i].points || "";
                        row.push(points);
                    } else {
                        // 空填空项（答案和分值）
                        row.push("");
                        row.push("");
                    }
                }
                 
                // 添加完整答案（解答题）
                row.push(q.type === 'essay' ? q.essayAnswer || "" : "");
                 
                // 添加关键词（最多5个）
                for (let i = 0; i < 5; i++) {
                    if (i < (q.keywords ? q.keywords.length : 0)) {
                        // 关键词
                        const keyword = q.keywords[i].keyword || "";
                        row.push(keyword);
                         
                        // 关键词分值
                        const points = q.keywords[i].points || "";
                        row.push(points);
                    } else {
                        // 空关键词（关键词和分值）
                        row.push("");
                        row.push("");
                    }
                }
                 
                // 添加评分规则（修改：解答题使用partialCredit）
                const scoringMode = q.type === 'essay' ? 
                    (q.essayScoringMode || 'partialCredit') : 
                    (q.blankScoringMode || "");
                row.push(scoringMode);
                 
                data.push(row);
            });
             
            // 创建工作表
            const ws = XLSX.utils.aoa_to_sheet(data);
            wb.Sheets["题库"] = ws;
             
            // 获取文件名
            let filename = exportFilename.value.trim();
            if (!filename) {
                filename = `题库_${new Date().toLocaleDateString()}`;
            } else {
                // 移除可能存在的.xlsx扩展名
                if (filename.toLowerCase().endsWith('.xlsx')) {
                    filename = filename.substring(0, filename.length - 5);
                }
            }
            filename += '.xlsx';
             
            // 导出Excel文件
            XLSX.writeFile(wb, filename);
             
            showNotification(`Excel文件已导出: ${filename}`);
        }
         
        // 导出CSV
        function exportCSV() {
            if (questions.length === 0) {
                showNotification('题库为空，无法导出', 'error');
                return;
            }
             
            // 创建CSV内容
            let csvContent = '问题,问题图片,选项A,选项A图片,选项B,选项B图片,选项C,选项C图片,选项D,选项D图片,选项E,选项E图片,选项F,选项F图片,答案,题目类型,题目分数,答案解析,填空项1,填空项1分值,填空项2,填空项2分值,填空项3,填空项3分值,填空项4,填空项4分值,填空项5,填空项5分值,填空项6,填空项6分值,完整答案,关键词1,关键词1分值,关键词2,关键词2分值,关键词3,关键词3分值,关键词4,关键词4分值,关键词5,关键词5分值,评分规则\n';
             
            questions.forEach(q => {
                // 添加问题
                csvContent += `"${q.text.replace(/"/g, '""')}",`;
                 
                // 添加问题图片
                csvContent += `"${q.image ? q.image.replace(/"/g, '""') : ''}",`;
                 
                // 添加选项（最多6个）
                for (let i = 0; i < 6; i++) {
                    if (i < q.options.length) {
                        // 选项文本
                        const text = q.options[i].text || '';
                        csvContent += `"${text.replace(/"/g, '""')}",`;
                         
                        // 选项图片
                        const image = q.options[i].image || '';
                        csvContent += `"${image.replace(/"/g, '""')}",`;
                    } else {
                        // 空选项（文本和图片）
                        csvContent += ',';
                        csvContent += ',';
                    }
                }
                 
                // 添加答案
                csvContent += `${q.correct.join('')},`;
                 
                // 添加题目类型
                csvContent += `${q.type},`;
                 
                // 添加题目分数
                csvContent += `${q.points},`;
                 
                // 添加答案解析
                csvContent += `"${q.explanation ? q.explanation.replace(/"/g, '""') : ''}",`;
                 
                // 添加填空项（最多6个）
                for (let i = 0; i < 6; i++) {
                    if (i < (q.blanks ? q.blanks.length : 0)) {
                        // 填空项答案
                        const answer = q.blanks[i].answer || '';
                        csvContent += `"${answer.replace(/"/g, '""')}",`;
                         
                        // 填空项分值
                        const points = q.blanks[i].points || '';
                        csvContent += `${points},`;
                    } else {
                        // 空填空项（答案和分值）
                        csvContent += ',';
                        csvContent += ',';
                    }
                }
                 
                // 添加完整答案（解答题）
                csvContent += `"${q.type === 'essay' ? (q.essayAnswer || '').replace(/"/g, '""') : ''}",`;
                 
                // 添加关键词（最多5个）
                for (let i = 0; i < 5; i++) {
                    if (i < (q.keywords ? q.keywords.length : 0)) {
                        // 关键词
                        const keyword = q.keywords[i].keyword || '';
                        csvContent += `"${keyword.replace(/"/g, '""')}",`;
                         
                        // 关键词分值
                        const points = q.keywords[i].points || '';
                        csvContent += `${points},`;
                    } else {
                        // 空关键词（关键词和分值）
                        csvContent += ',';
                        csvContent += ',';
                    }
                }
                 
                // 添加评分规则（修改：解答题使用partialCredit）
                const scoringMode = q.type === 'essay' ? 
                    (q.essayScoringMode || 'partialCredit') : 
                    (q.blankScoringMode || '');
                csvContent += `${scoringMode}\n`;
            });
             
            // 获取选择的编码格式
            const encoding = commonEncoding.value;
             
            // 获取文件名
            let filename = exportFilename.value.trim();
            if (!filename) {
                filename = `题库_${new Date().toLocaleDateString()}`;
            } else {
                // 移除可能存在的.csv扩展名
                if (filename.toLowerCase().endsWith('.csv')) {
                    filename = filename.substring(0, filename.length - 4);
                }
            }
            filename += '.csv';
             
            // 创建Blob对象
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
             
            showNotification(`CSV文件已导出: ${filename}`);
        }
         
        // 处理文件导入
        function handleFileImport(e) {
            const file = e.target.files[0];
            if (!file) return;
             
            const reader = new FileReader();
             
            reader.onload = function(event) {
                try {
                    const data = event.target.result;
                     
                    // 根据文件扩展名判断格式
                    if (file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls')) {
                        // Excel文件处理
                        handleExcelImport(data);
                    } else if (file.name.toLowerCase().endsWith('.csv')) {
                        // CSV文件处理
                        handleCSVImport(data);
                    } else {
                        showNotification('不支持的文件格式', 'error');
                    }
                } catch (error) {
                    console.error('导入失败:', error);
                    showNotification('导入失败，请检查文件格式', 'error');
                }
            };
             
            reader.onerror = function() {
                showNotification('文件读取失败', 'error');
            };
             
            // 读取文件
            if (file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls')) {
                reader.readAsArrayBuffer(file);
            } else {
                reader.readAsText(file, 'UTF-8');
            }
        }
         
        // 处理Excel导入
        function handleExcelImport(data) {
            try {
                const workbook = XLSX.read(data, { type: 'array' });
                 
                // 获取第一个工作表
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                 
                // 将工作表转换为JSON
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                 
                // 检查标题行
                if (jsonData.length === 0 || jsonData[0][0] !== "问题") {
                    showNotification('Excel格式不正确，缺少标题行', 'error');
                    return;
                }
                 
                // 跳过标题行
                const parsedQuestions = [];
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (!row || row.length === 0) continue;
                     
                    // 提取问题
                    const questionText = row[0] || "";
                    const questionImage = row[1] || "";
                     
                    // 提取选项（最多6个）
                    const options = [];
                    for (let j = 0; j < 6; j++) {
                        const textIndex = 2 + j * 2;
                        const imageIndex = textIndex + 1;
                         
                        if (textIndex < row.length && (row[textIndex] || row[imageIndex])) {
                            options.push({
                                text: row[textIndex] || "",
                                image: row[imageIndex] || ""
                            });
                        }
                    }
                     
                    // 提取答案
                    const answers = (row[14] || "").toString().toUpperCase().split('');
                     
                    // 提取题目类型（第15列）
                    let type = "multiple"; // 默认多选题
                    if (row.length >= 16 && row[15]) {
                        const typeStr = row[15].toString().toLowerCase();
                        if (typeStr === "single") {
                            type = "single";
                        } else if (typeStr === "truefalse") {
                            type = "truefalse";
                        } else if (typeStr === "fillblank") {
                            type = "fillblank";
                        } else if (typeStr === "essay") {
                            type = "essay";
                        }
                    }
                     
                    // 提取题目分数（第16列）
                    let points = 1; // 默认1分
                    if (row.length >= 17 && row[16]) {
                        const pointsValue = parseInt(row[16]);
                        if (!isNaN(pointsValue)) {
                            points = pointsValue;
                        }
                    }
                     
                    // 提取答案解析（第17列）
                    const explanation = row[17] || "";
                     
                    // 提取填空项
                    const blanks = [];
                    let blankScoringMode = "allOrNothing";
                     
                    if (type === "fillblank") {
                        // 提取填空项（最多6个）
                        for (let j = 0; j < 6; j++) {
                            const answerIndex = 18 + j * 2;
                            const pointsIndex = answerIndex + 1;
                             
                            if (answerIndex < row.length && row[answerIndex]) {
                                blanks.push({
                                    answer: row[answerIndex] || "",
                                    points: parseInt(row[pointsIndex]) || 1
                                });
                            }
                        }
                    }
                     
                    // 提取完整答案（第30列）
                    const essayAnswer = row.length >= 31 ? row[30] || "" : "";
                     
                    // 提取关键词
                    const keywords = [];
                    if (type === "essay") {
                        // 提取关键词（最多5个）
                        for (let j = 0; j < 5; j++) {
                            const keywordIndex = 31 + j * 2;
                            const pointsIndex = keywordIndex + 1;
                             
                            if (keywordIndex < row.length && row[keywordIndex]) {
                                keywords.push({
                                    keyword: row[keywordIndex] || "",
                                    points: parseInt(row[pointsIndex]) || 1
                                });
                            }
                        }
                    }
                     
                    // 提取评分规则（最后列）
                    let essayScoringMode = "partialCredit"; // 解答题默认按关键词给分
                    if (row.length >= 41 && row[40]) {
                        essayScoringMode = row[40] || "partialCredit";
                    }
                     
                    // 创建题目对象
                    const question = {
                        id: Date.now() + i, // 唯一ID
                        text: questionText,
                        image: questionImage,
                        explanation: explanation,
                        type: type,
                        points: points,
                        options: options,
                        correct: answers,
                        blanks: blanks,
                        essayAnswer: essayAnswer,
                        keywords: keywords,
                        blankScoringMode: blankScoringMode,
                        essayScoringMode: essayScoringMode // 新增解答题评分规则
                    };
                     
                    parsedQuestions.push(question);
                }
                 
                if (parsedQuestions.length > 0) {
                    // 添加到题库
                    questions = questions.concat(parsedQuestions);
                    renderQuestionList();
                     
                    // 启用按钮
                    exportExcelBtn.disabled = false;
                    exportCsvBtn.disabled = false;
                    clearAllBtn.disabled = false;
                     
                    showNotification(`成功导入 ${parsedQuestions.length} 道题目`);
                } else {
                    showNotification('未找到有效的题目数据', 'error');
                }
            } catch (error) {
                console.error('导入Excel失败:', error);
                showNotification('导入失败，请检查文件格式', 'error');
            }
        }
         
        // 处理CSV导入
        function handleCSVImport(csvText) {
            try {
                // 解析CSV内容
                const parsedQuestions = parseCSV(csvText);
                 
                if (parsedQuestions.length > 0) {
                    // 添加到题库
                    questions = questions.concat(parsedQuestions);
                    renderQuestionList();
                     
                    // 启用按钮
                    exportExcelBtn.disabled = false;
                    exportCsvBtn.disabled = false;
                    clearAllBtn.disabled = false;
                     
                    showNotification(`成功导入 ${parsedQuestions.length} 道题目`);
                } else {
                    showNotification('未找到有效的题目数据', 'error');
                }
            } catch (error) {
                console.error('导入CSV失败:', error);
                showNotification('导入失败，请检查文件格式', 'error');
            }
        }
         
        // 解析CSV内容
        function parseCSV(csvText) {
            const questions = [];
            const lines = csvText.split('\n');
             
            // 检查标题行
            if (lines.length === 0 || !lines[0].startsWith('问题,问题图片')) {
                showNotification('CSV格式不正确，缺少标题行', 'error');
                return [];
            }
             
            // 跳过标题行
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue; // 跳过空行
                 
                // 分割CSV行
                const fields = parseCSVLine(line);
                 
                // 检查字段数量
                if (fields.length < 17) {
                    console.warn(`跳过第 ${i+1} 行: 字段数量不足`, fields);
                    continue;
                }
                 
                // 提取问题
                const questionText = fields[0];
                const questionImage = fields[1];
                 
                // 提取选项（最多6个）
                const options = [];
                for (let j = 0; j < 6; j++) {
                    const textIndex = 2 + j * 2;
                    const imageIndex = textIndex + 1;
                     
                    if (textIndex < fields.length && (fields[textIndex] || fields[imageIndex])) {
                        options.push({
                            text: fields[textIndex] || '',
                            image: fields[imageIndex] || ''
                        });
                    }
                }
                 
                // 提取答案
                const answers = fields[14].toUpperCase().split('');
                 
                // 提取题目类型（第15列）
                let type = 'multiple'; // 默认多选题
                if (fields.length >= 16 && fields[15]) {
                    const typeStr = fields[15].toLowerCase();
                    if (typeStr === 'single') {
                        type = 'single';
                    } else if (typeStr === 'truefalse') {
                        type = 'truefalse';
                    } else if (typeStr === 'fillblank') {
                        type = 'fillblank';
                    } else if (typeStr === 'essay') {
                        type = 'essay';
                    }
                }
                 
                // 提取题目分数（第16列）
                let points = 1; // 默认1分
                if (fields.length >= 17 && fields[16]) {
                    const pointsValue = parseInt(fields[16]);
                    if (!isNaN(pointsValue)) {
                        points = pointsValue;
                    }
                }
                 
                // 提取答案解析（第17列）
                let explanation = '';
                if (fields.length >= 18) {
                    explanation = fields[17];
                }
                 
                // 提取填空项
                const blanks = [];
                let blankScoringMode = 'allOrNothing';
                 
                if (type === 'fillblank') {
                    // 提取填空项（最多6个）
                    for (let j = 0; j < 6; j++) {
                        const answerIndex = 18 + j * 2;
                        const pointsIndex = answerIndex + 1;
                         
                        if (answerIndex < fields.length && fields[answerIndex]) {
                            blanks.push({
                                answer: fields[answerIndex] || '',
                                points: parseInt(fields[pointsIndex]) || 1
                            });
                        }
                    }
                }
                 
                // 提取完整答案（第30列）
                const essayAnswer = fields.length >= 31 ? fields[30] || "" : "";
                 
                // 提取关键词
                const keywords = [];
                if (type === 'essay') {
                    // 提取关键词（最多5个）
                    for (let j = 0; j < 5; j++) {
                        const keywordIndex = 31 + j * 2;
                        const pointsIndex = keywordIndex + 1;
                         
                        if (keywordIndex < fields.length && fields[keywordIndex]) {
                            keywords.push({
                                keyword: fields[keywordIndex] || '',
                                points: parseInt(fields[pointsIndex]) || 1
                            });
                        }
                    }
                }
                 
                // 提取评分规则（最后列）
                let essayScoringMode = "partialCredit"; // 解答题默认按关键词给分
                if (fields.length >= 41 && fields[40]) {
                    essayScoringMode = fields[40];
                }
                 
                // 创建题目对象
                const question = {
                    id: Date.now() + i, // 唯一ID
                    text: questionText,
                    image: questionImage || '',
                    explanation: explanation,
                    type: type,
                    points: points,
                    options: options,
                    correct: answers,
                    blanks: blanks,
                    essayAnswer: essayAnswer,
                    keywords: keywords,
                    blankScoringMode: blankScoringMode,
                    essayScoringMode: essayScoringMode // 新增解答题评分规则
                };
                 
                questions.push(question);
            }
             
            return questions;
        }
         
        // 解析CSV行
        function parseCSVLine(line) {
            const fields = [];
            let currentField = '';
            let inQuotes = false;
            let escapeNext = false;
             
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                 
                if (escapeNext) {
                    currentField += char;
                    escapeNext = false;
                    continue;
                }
                 
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        // 转义引号
                        currentField += '"';
                        i++; // 跳过下一个引号
                    } else {
                        inQuotes = !inQuotes;
                    }
                    continue;
                }
                 
                if (char === ',' && !inQuotes) {
                    fields.push(currentField);
                    currentField = '';
                    continue;
                }
                 
                if (char === '\\') {
                    escapeNext = true;
                    continue;
                }
                 
                currentField += char;
            }
             
            // 添加最后一个字段
            fields.push(currentField);
             
            return fields;
        }
         
        // 显示通知
        function showNotification(message, type = 'success') {
            const content = notification.querySelector('#notification-message');
            content.textContent = message;
             
            notification.className = 'notification';
            notification.classList.add('show', type);
             
            // 更新图标
            const icon = notification.querySelector('i');
            if (type === 'error') {
                icon.className = 'fas fa-exclamation-circle';
            } else {
                icon.className = 'fas fa-check-circle';
            }
             
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
         
        // 初始化应用
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>